# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각
- 대규모 데이터를 다루는 방법은?
- 구글맵은 어떤 로직으로 돌아가고 있을까?

## 📝 2. 내용 정리
### 1단계 : 지도 101
1. 측위 시스템
    - 구 표면 상의 위치를 표현하는 체계.

2. 3차원 위치의 2차원 변환
    - 3차원 구를 2차원으로 대응시키는 방법을 `지도 투영법` 또는 `도법`이라고 부른다.
    - 구글 맵은 메르카토르 도법을 변경한 `웹 메르카토르`도법을 택하고 있다.

3. 지오코딩
    - 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스이다.
    - 지오코딩은 인터폴레이션으로 수행된다. 다양한 시스템이 제공하는 데이터를 결합한다는 의미이다.

4. 지오해싱
    - 2차원의 평면 공간에 작은 격자로 나누어 영문과 숫자로 구성된 짧은 문자열에 격자를 대응시키는 방법이다.
    - 1장에서 나온 내용을 그대로 계속해서 격자를 나누는 방법이다.

5. 지도 표시
    - 사용자가 보려는 영역에 관계된 타일만 다운받아 모자이크처럼 이어 붙인 다음 화면에 뿌리는 방법이다.

6. 경로 안내 알고리즘을 위한 도로 데이터 처리
    - 경로탐색 - 데이크스트라 알고리즘 OR A*경로 탐색 알고리즘의 변종이다.
    - 경로 탐색 알고리즘의 성능은 주어진 그래프 크기에 아주 민감하다.

7. 계층적 경로 안내 타일
    - 경로 안내가 효과적으로 동작하려면 필요한 수준의 구체성을 갖춘 도로 데이터가 필요하다.
    - 결과를 얻는 데 너무 많은 시간이 걸릴 수 있어 구체성 정도를 상/중/하로 구분한다.

### 1단계 : 개략적 규모 추정
1. 저장소 사용량
    - 메타데이터 : 각 지도 타일의 메타데이터는 매우 작다.
    - 도로 정보 : 수 TB 용량을 도로 데이터를 보유하고 있다.

2. 세계 지도
    - 확대 수준 별로 지도 타일을 한 벌씩 두어야 한다.
        - 타일을 모두 보관하려면 최대 확대해 필요한 타일의 개수를 따져보는게 좋다.
    - 사람이 살지 않는 지역을 제외하면 80 ~ 90% 정도 저장 용량을 절감할 수 있다.

3. 서버 대역폭
    - 1번 요청 : 경로 안내 요청으로 클라이언트가 경로 안내 세션을 시작할 떄 전송하는 메세지다.
    - 2번 요청 : 위치 갱신 요청이다.
    -> QPS는 최종적으로 계산하면 3백만 QPS이지만 덜 자주 보내도록하면 줄일 수 있다. 15초마다 보내면 1백만 QPS까지 줄일 수 있다.

### 2단계
1. 위치 서비스
    - 사용자의 위치를 기록하는 역할을 담당한다.
    - 도로 분석이나 추적이 가능하고 개인화가 가능하다는 장점이 있다
    - 하지만 주기적으로 보낼 필요는 없다.
    - 통신 프로토콜은 HTTP를 keep-alive 옵션과 함께 사용하면 효율을 높일 수 있으므로 좋은 선택일 것이다.

2. 경로 안내 서비스
    - A에서 B지점으로 가는 합리적으로 빠른 경로를 찾아주는 역할을 담당한다.

3. 지도 표시
    - 선택지1 : 클라이언트 위치, 현재 클라이언트가 보는 지도의 확대 수준에 근거하여 필요한 지도 타일을 즉석에서 만드는 방법이다.
        - 지도 타일을 동적으로 만들어 서버 부하가 심하다.
        - 캐시를 활용하기가 어렵다.
    - 선택지2 : 미리 만들어둔 타일을 전달하는 방법이다.
        - 캐시 방법이 가능하다.
        - 규모 확장이 용이하고 성능 측면에서도 유리하다.
    

### 3단계 : 상세 설계
1. 경로 안내 타일
    - 가공되지 않은 데이터라 가공 파이프라인을 주기적으로 실행하여 경로 안내 타일로 변환한다.
    - 해상도를 달리하여 세 벌을 만들어야한다.
    - 메모리에 인접 리스트 형태로 보관하는것이 일반적이지만 메모리에 두기에는 양이 너무 많아 그래프의 노드와 선을 데이터베이스 레코드로 저장하는 방법도 있지만 비용이 너무 많이든다. 그래서 S3 같은 객체 저장소에 파일을 보관하고 그 파일을 이용할 경로 안내 서비스에서 적극적으로 캐싱하는 것이 가장 적합하다.

2. 사용자 위치 데이터
    - 실시간 교통 상황 데이터나 교통 상황 이력 DB 구축하는 데도 활용된다.
    - 카산드라를 사용하는게 가장 적합하다.

3. 지오코딩 DB
    - 읽기 연산은 빈번하고 쓰기연산은 드물어 레디스처럼 빠른 읽기 연산을 제공하는 키-값 저장소가 이 용도에 적합하다.

4. 미리 만들어 둔 지도 이미지
    - 같은 이미지를 중복으로 요청하는 경우가 많아 이미지는 한 번만 계산하고 그 결과는 캐시에 두는 전략을 쓰는것이 가장 좋다.

5. 위치 서비스
    - 사용자 위치 데이터 저장에는 키-값 저장소를 활용한다.
    - 초당 백만 건이라 연산 지원에 탁월한 DB가 필요하다.
    - 변경되고 나면 이전 정보는 바로 무용해진다.

6. 사용자 위치 데이터는 어떻게 이용되는가
    - 폐쇄된 도로를 감지할 수 있다.
    - 지도 데이터 정확성을 개선하는 입력으로도 활용할 수 있다.
    - 실시간 교통 현황을 파악하는 입력이 될 수도 있다.

7. 지도 타일 사전 계산
    - 사용자가 보는 지도 크기나 확대 수준에 맞는 세부사항을 보여주기 위해서는 확대 수준별 지도 타일을 미리 만들어둘 필요가 있다. 수준에 따라 이전수준 대비 4배씩 늘어난다.
        - 최적화 : 벡터 사용
            - 네트워크를 통해 이미지를 전송하는 대신 경로와 다각형 등의 벡터 정보를 보내는 것이다.

8. 지오코딩 서비스
    - 주소의 표현 방식은 다양할 수 있다는 점을 고려해야한다.

9. 최단 경로 서비스
    - 출발지와 목적지 위도/경도를 입력으로 받아 k개 최단 경로를 반호나하는 서비스다.
    - 도로망 그래프는 거의 정적이므로 캐시해 두면 좋다.
    - A*경로 탐색 알고리즘의 한 형태를 실행한다.
        - 위 경도를 받음. 이 위치 정보를 지오해시로 변환한 다음 출발지와 목적지 경로 안내 타일을 얻는다.
        - 출발지 타일에서 시작하여 그래프 자료 구조를 탐색해 나간다.

10. 예상 도착 시간 서비스
    - 기계 학습을 활용해 현재 교통 상황 및 과거 이력에 근거하여 예상 도착 시간을 계산한다.
    - 까다로운건 10, 20분 뒤 교통상황이다.


## 💡 3. 전부 읽고 난 후기
- 구글 맵 하나를 이렇게 설계해보니 설계의 중요성을 알 수 있었다.
- 수많은 위/경도 데이터와 위치정보를 다룰거라고 생각했지만 생각보다 더 큰 트래픽과 더 큰 데이터량에 놀랐다. 그래도 최적화를 진행할 방법은 항상 있는것에 신기했다.

## ❓ 4. 특별히 궁금했던 부분
- 위치서비스에서 통신 프로토콜은 왜 HTTP 말고 다른 대안은 없을까?
- 대규모 데이터를 처리하면서 노이즈를 제거하는 방법은 무엇일까?