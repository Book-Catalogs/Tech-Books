# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각
- 지표 모니터링과 경보시스템에는 실시간 처리가 필수일것 같은데, 어느 기술스택을 사용해야할까?

## 📝 2. 내용 정리
### 기본적 사항
1. 데이터 수집 : 여러 출처로부터 지표 데이터 수집
2. 데이터 전송 : 지표 데이터를 지표 모니터링 시스템으로 전송
3. 데이터 저장소 : 전송되어 오는 데이터를 정리하고 저장
4. 경보 : 밀려오는 데이터를 분석하고 이상 징후를 감지하고 경보를 발생
5. 시각화 : 데이터를 차트나 그래프 등으로 제공

### 데이터 모델
- 시계열 데이터로 기록(값 집합에 타임스탬프가 붙는 형태)
> 사례 1 : 프로덕션에서 사용중인 서버 인스턴스 i631의 20:00 시점의 CPU 부하를 알고 싶다고 하면, 시계열 데이터로 지표이름, 레이블, 특정한 시각에 측정된 지표 데이터로 구성되어 있음을 확인할 수 있다.

> 사례 2 : 지난 10분간 특정 지역에 위치한 모든 웹 서버의 CPU 부하 평균값은 얼마인가? 라는 질문에 답하려면 지표 이름이 `CPU.load`이고 레이블에 포함된 지역 이름이 특정 지역인 데이터를 저장소에서 가져와 평균값을 구하면 된다. 프로메테우스나 openTSDB가 그 사례이다.

### 데이터 접근 패턴
- 시점을 막론하고 많은 시계열 데이터가 기록될 수 있어 시스템에 대한 쓰기 부하는 막대하다.
- 읽기 부하는 일시적으로 치솟았다 사라지는 편이라고 봐야한다.

### 데이터 저장소 시스템
- 본 설계안의 핵심으로 지표 모니터링 및 경보 시스템을 위한 저장소 시스템을 직접 설계하거나 MySQL 같은 범용의 저장소 시스템을 사용하는 선택지 가운데 어떤것도 추천하지 않는다.
    - 범용데이터베이스(MySQL)는 시계열 데이터를 처리할 수 있지만 전문가 수준의 튜닝이 필요하다.
    - NoSQL은 시계열 데이터를 효율적으로 처리할 수 있지만 확장이 용이한 스키마를 설계해야하는데 그러려면 NoSQL 데이터베이스의 내부 구조에 대해 해박한 지식이 필요하다.
- 시장에 이미 많이 나와있는 시계열에 최적화된 데이터베이스는 시계열 데이터 분석에 적합ㄴ하다. 그리고 쉬운 질의 인터페이스도 갖추고 있다.

#### 예시
1. openTSDB : Hadoop(하둡)과 HBase에 기반하고 있어 Hadoop/HBase 클러스터를 구성하고 운영해야 하므로 복잡하다.
2. MetricsDB : X에서 사용한다.
3. 타임스트림 : 아마존에서 출시했다.
등등.

### 개략적 설계안
1. 지표 출처 : 지표 데이터가 만들어지는 곳으로 애플리케이션 서버, SQL DB, 메시지 큐 등 어떤것이등 가능
2. 지표 수집기 : 지표 데이터를 수집하고 시계열 데이터를 기록하는 역할
3. 시계열 데이터베이스 : 지표 데이터를 시계열 데이터형태로 보관하는 저장소
4. 질의 서비스 : 시계열 데이터베이스에 보관된 데이터를 질의하고 가져오는 과정을 돕는 서비스
5. 경보 시스템 : 경보를 받아야 하는 다양한 대상으로 경보 알림을 전송하는 역할
6. 시각화 시스템 : 지표를 다양한 형태의 그래프/차트로 시각화 하는 기능을 제공하는 시스템

### 지표 수집
- 카운터나 CPU 사용량 같은 지표를 수집할 때는 데이터가 소실되어도 아주 심각한 문제는 아니다. 지표를 보내는 클라이언트는 데이터가 성공적으로 전송됐는지 신경쓰지 않아도 된다.

#### 풀 vs 푸시 모델
1. 풀 모델 : 지표 수집기는 데이터를 가져올 서비스 목록을 알아야한다. 지표수집기 서버 안에 모든 서비스 앤드포인트의 DNS/IP 정보를 담은 파일을 두면 가장 간단하지만 수시로 추가/삭제되는 대규모 운영 환경에는 적용하기 어렵다. etcd나 아파치 주키퍼 같은 서비스 탐색 기술을 활용하면 이 문제는 해결할 수 있다. 하지만 수천 대 서버가 만들어 내는 지표 데이터를 수집하려면 지표 수집기 서버 한대로는 부족하다. 안전 해시링을 사용하면 구현할 수 있다.
2. 푸시 모델 : 서버나 데이터베이스 서버 같은 서버가 직접 지표를 수집기에 전송하는 모델이다. 데이터 집계는 수집기에 보내는 데이터의 양을 줄이는 효과적인 방법이다. 

> 풀모델과 푸시모델 장단점 비교 : 풀 모델을 채택한 유명한 사례로는 프로메테우스, 푸시 모델을 채택한 유명사례로는 아마존 클라우드와치와 그래파이트 등이 존재한다. 하지만 두 모델의 정답은 없다.

### 지표 전송 파이프라인의 규모 확장
- 풀 모델과 푸시 모델 가운데 무엇을 채택할지 여부에 관계없이 지표 수집기는 서버 클러스터 형태이며 엄청난 양의 데이터를 받아 처리해야 한다. 아울러 이 클러스터는 자동으로 규모 확장이 가능하도록 설정하여 언제나 데이터 처리에 충분한 수집기 서버가 존재하도록 해야한다.
- 스트림 처리 서비스가 해당 데이터를 받아 시계열 데이터베이스에 저장하는 접근법에는 장점이 존재한다.
    - 카프카는 고도로 안정적이고 규모 확장성이 뛰어난 분산 메시지 플랫폼이다.
    - 데이터 수집 컴포넌트와 처리 컴포넌트 사이의 결합도를 낮춘다.
    - 데이터베이스에 장애가 생겨도 데이터는 소실되지 않는다.
    
#### 카프카를 통한 규모 확장
- 카프카에 내장된 파티션 매커니즘을 사용하면 시스템의 규모를 다양한 방법으로 확장할 수 있다.

#### 카프카의 대안
- 고릴라와같이 네트워크 장애가 발생해도 높은 수준의 쓰기 연산 가용성을 유지한다. 이런 시스템을 쓴다면 카프카 같은 메시지 큐가 없어도 같은 수준의 안정성을 제공할 수 있다고 주장할 수 있다.

### 데이터 집계 지점
- 수집 에이전트나 데이터 수집을 사용할수도 있다 그리고 질의 시점에 할 수도 있다.
    - 수집 에이전트가 집계하는 방안 : 복잡한 집계 로직은 지원하기 어렵다.
    - 데이터 수집 파이프라인에서 집계하는 방안 : 스트림 프로세싱 엔진이 필요하다. 데이터베이스에는 계산 결과만 기록하므로, 실제로 기록되는 양은 엄청나게 줄어든다. 하지만 이 방안은 늦게 도착하는 지표 데이터의 처리가 어렵다
    - 질의 시에 집계하는 방안 : 데이터를 날것 그대로 보관한 다음 질의할 때 필요한 시간 구간에 맞게 집계한다. 데이터 손실 문제는 없으나 질의를 처리하는 순간에 전체 데이터세트를 ㅅ대상으로 집계 결과를 계산해야 하므로 속도는 느리다.

### 질의 서비스
- 질의 서버 클러스터 형태로 구현된다. 시각화 또는 경보 시스템에서 접수된 요청을 시계열 데이터베이스를 통해 처리하는 역할을 담당한다.
- 질의 처리 전담 서비스를 두면 데이터베이스를 자유롭게 다른 제품으로 교체할수도 있다.

### 캐시 계층
- 질의 결과를 저장할 캐시 서버를 도입하면 시계열 데이터베이스에 대한 질의 부하를 낮추고 질의 서비스의 성능을 높일 수 있다.

#### 질의 서비스를 두면 곤란한 경우
- 대부분 시계열 데이터베이스와 연동을 처리하는 강력한 플러그인을 갖추고 있는 경우가 많아 별도 캐시를 도입할 필요가 없는 시계열 데이터베이스가 있다는 것을 고려해야한다.

### 시계열 데이터베이스 질의어
- 프로메테우스나 InfluxDB는 SQL이 아닌 독자 질의어를 제공한다. 지수 이동 평균 계산식은 SQL로 작성하면 까다롭다. 하지만 시계열 데이터베이스 분석에 최적화된 플럭스라는 언어로 작성하면 이해하기 훨씬 쉬워진다.

### 저장소 계층
#### 시계열 데이터베이스는 신중하게 선택할 것
- 운영 데이터 저장소에 대한 질의의 85%는 26시간 내에 수집된 데이터를 대상으로 한다. 이 사실을 잘 확용하는 시계열 데이터베이스를 고르면 성능 측면에서 큰 이득을 볼 수 있다.

#### 저장 용량 최적화
- 데이터의 양은 막대하다.
    - 데이터 인코딩 및 압축 : 인코딩하고 압축하면 크기를 상당히 줄일 수 있다.
    - 다운샘플링 : 해상도를 낮춰 저장소 요구량을 줄이는 기법이다. 일자별로 해상도를 낮춰 보관한다.
    - 냉동 저장소 : 잘 사용되지 않는 비활성 상태 데이터를 보관하는 곳이다.드는 비용은 일반 저장소에 비해 저렴하다.

### 경보 시스템 
1. 설정 파일을 가져와 캐시 서버에 보관
2. 경보관리자는 경보 설정 내역을 캐시에서 가져옴
3. 규칙에 근거하여 시간마다 질의 서비스를 호출 그리고 질의 결과가 설정된 임계값을 위반하면 경보 이벤트 생성
4. 경보 저장소는 카산드라 같은 형태의 키-값 저장소로 모든 경보의 상태가 보관됨
5. 경보 이벤트를 카프카에 전달
6. 경보 소비자는 카프카에 경보 이벤트를 읽음
7. 경보 소비자는 카프카에서 읽은 경보 이벤트를 앤드포인트로 알림을 전송


### 시각화 시스템
- 지표 대시보드에 지표를 다양한 시간 범위로 표시하고 경보 대시보드에는 다양한 경보의 상태를 표시한다.
- 품질 좋은 시각화 시스템은 구현하기 어렵다. 상용품을 구입해서 쓰자고 주장하는 것이 바람직하다.

## 💡 3. 전부 읽고 난 후기
- 데이터 수집, 정송, 저장, 경보, 시각화의 기본적 흐름을 파악할 수 있었고, 특히 데이터 모델이 시계열 데이터 형태로 저장되는 것과 이를 질의하는 방식에 대해 알게 되었다.

## ❓ 4. 특별히 궁금했던 부분
- 모니터링 시스템을 구축할 때 초기에 꼭 필요한 지표는 무엇일까요? 서비스 운영 초기에는 어떤 지표를 중점적으로 모니터링 하는 것이 좋을까요?
