# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각
- 객체 저장소 설계를 할때 이미지나 파일은 어떻게 저장해야할까?

## 📝 2. 내용 정리
### 저장소 종류
1. 블록 저장소 :
    - HDD나 SSD처럼 서버에 물리적으로 연결되는 형태의 드라이브 블록 저장소
2. 파일 저장소 :
    - 파일과 디렉터리를 손쉽게 다루는데 필요한, 더 높은 수준의 추상화를 제공
3. 객체 저장소 :
    - 데이터 영속성을 높이고 대규모 애플리케이션을 지원하며 비용을 낮추기 위해 의도적으로 성능을 희생

### 규모 추정
- 6억 8천만개의 객체
- 메타데이터 크기가 대략 1KB라고 가정한다면 0.68TB 정도의 공간이 필요하다.

### 개략적 설계안
1. 로드밸런서 : RESTful API에 대한 요청을 API 서버들에 분산하는 역할을 담당
2. API 서비스 : IAM 서비스, 메타데이터 서비스, 저장소 서비스에 대한 호출을 조율하는 역할을 담당
3. IAM 서비스 : 인증, 권한 부여, 접근 제어 등을 중앙에서 맡아 처리
4. 데이터 저장소 : 실제 데이터를 보관하고 필요할 때마다 읽어가는 장소
5. 데이터 저장소 : 객체 메타데이터를 보관하는 장소

### 데이터 저장소
- API 서비스는 사용자의 요청을 받으면 그 요청을 처리하기 위해 다른 내부 서비스들을 호출한다. 객체를 저장하거나 가져오는 작업은 데이터 저장소를 호출하여 처리한다.

### 데이터 저장 흐름
1. API 서비스는 객체 데이터를 데이터 저장소로 포워딩한다.
2. 데이터 라우팅 서비스는 해당 객체에 UUID를 할당하고 배치 서비스에 해당 객체를 보관할 데이터 노드를 질의한다.
3. 데이터 라우팅 서비스는 저장할 데이터를 UUID와 함께 주 데이터 노드에 직접 전송한다.
4. 주 데이터 노드는 자기 노드에 지역적으로 저장하는 한편, 두 개의 부 데이터 노드에 다중화한다.
5. 객체의 UUID 객체 ID를 API 서비스에 반환한다.

### 데이터는 어떻게 저장되는가
- 작은 파일이 많아지면 두가지 문제가 생긴다.
    - 첫째, 낭비되는 데이터 블록 수가 늘어난다.
    - 둘째, 시스템의 아이노드 용량 한계를 초고하는 문제다.
- 위의 문제들은 작은 객체들을 큰 파일 하나로 모아서 해결할 수 있다.

### 데이터 내구성
- 데이터의 안정성은 데이터 저장 시스템에 아주 중요하다.
**하드웨어 장애와 장애 도메인**
- 여러 대의 하드 드라이브에 복제하여 어떤 드라이브에서 발생한 장애가 전체 데이터 가용성에 영향을 주지 않도록 하는 것이다.
**소거 코드**
- 데이터를 3중으로 다중화하면 대략 99.999%의 내구성을 달성할 수 있다.
- 소거 코드라는 방안도 존재하는데, 소거 코드는 데이터 내구성을 다른 관점에서 달성하려 시도한다.
- 데이터를 작은 단위로 분할하여 다른 서버에 배치하는 한편, 그 가운데 일부가 소실되었을 때 복구하기 위한 패리티라는 정보를 만들어 중복성을 확보하는 것이다.
**정확성 검증**
- 대규모 시스템의 경우 데이터 훼손 문제는 디스크에 국한되지 않는다.
- 메모리의 데이터가 망가지는 일도 자주 일어난다.
- 체크섬을 두어 해결할 수 있다.

### 메타데이터 데이터 모델
1. 스키마 :
    - 객체 이름으로 객체 ID 찾기
    - 객체 이름에 기반하여 객체 삽입 또는 삭제
    - 같은 접두어를 갖는 버킷 내의 모든 객체 목록 확인
2. bucket 테이블의 규모 확장
    - 데이터베이스 사본을 만들어 읽기 부하를 분산한다.
3. object 테이블 규모 확장
    - 샤딩을 통해 객체 메타데이터 테이블의 규모를 확장한다.
    - bucket_id를 기준으로 삼아 같은 버킷내 객체는 같은 샤드에 배치되도록 한다.

### 분산 데이터베이스
- 메타데이터 테이블을 샤딩하면 어떤 샤드에 데이터가 있는지 모르므로 목록 출력 기능을 구현하기가 어렵다.
- 단순한 해결책은 검색 질의를 모든 샤드에 돌린 다음 결과를 취합하는 것이다.

### 큰 파일의 업로드 성능 최적화
- 큰 객체를 작게 쪼갠 다음 독립적으로 업로드 해야한다.
- 모든 조각이 업로드 되고 나면 객체 저장소는 그 조각을 모다서 원본 객체를 복원한다.

### 쓰레기 수집
- 더 이상 사용되지 않는 데이터에 할당된 저장 공간을 자동으로 회수하는 절차이다.

1. 객체의 지연된 삭제 : 삭제했다고 표시는 하지만 실제로 지우지 않음
2. 갈 곳 없는 데이터 : 반쯤 업로드된 데이터, 또는 취소된 멀티파트 업로드 데이터
3. 훼손된 데이터 : 체크섬 검사에 실패한 데이터


## 💡 3. 전부 읽고 난 후기
- 뭔소린지 모르겠다.............................................................................

## ❓ 4. 특별히 궁금했던 부분
- 멀티파트에서 큰 파일을 조각내서 업로드 하는데, 파일을 복원할때 성능 저하는 없는지 궁금하다.