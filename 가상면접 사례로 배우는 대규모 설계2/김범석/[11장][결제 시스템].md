# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각

- 나중에 결제 도메인을 다룬다고 가정하고 얻을 수 있는 점을 봐 보자.

## 📝 2. 내용 정리

대금 수신 흐름 Component

- 결제 서비스 
  - 사용자로부터 결제 이벤트를 수락하고 프로세스를 조율
  - 고려 해야 할 사항 : 자금 세탁 혹은 테러 자금 조달과 같은 비 정상적인 프로세스 감지 
- 결제 실행자
  - 결제 서비스 공급자를 통해 결제 주문을 실행
- 결제 서비스 공급자
  - 돈을 옮기는 역할을 담당 
- 원장
  - 결제 트랜잭션에 대한 금융기록
- 지갑 
  - 판매자의 계정 잔액 혹은 구매자의 결제 내역 조회 등..

 **금액의 타입 : String**

> 프로토콜, 소프트웨어, 하드웨어에 따라 직렬화/역직렬화시 사용하는 숫자 정밀도가 다를 수 있음
>
> 의도하지 않은 오류를 방지하기 위해 String 사용
>
> 또한 해외 결제를 지원할 경우 해당 숫자는 매우 클 수도, 작을수도 있음

복식부기 원장 시스템 (= 회계 / 부기)

- 모든 결제 거래를 두개의 별도 원장 ㅖ좌에 같은 금액으로 기록
  - 송금자는 차감 / 나머지는 입금
- 모든 거래 항목의 합계는 0 이어야 함

PSP 연동 방식

1. API를 통해 PSP와 연동하는 방법
   - 민감한 결제 정보를 안전하게 저장 할 수 있어야 함

2. 외부 결제 페이지를 사용하는 방식
   - 민감한 결제 정보를 별도로 저장하지 않아도 됨

조정

- 비동기 통신 간에 정확성을 보장하기 위한 방식
- 대부분의 PSP의 경우 정산 파일을 제공함 (하루 동안의 해당 계좌에서 발생한 모든 거래내역)
- 정산 파일의 세부정보를 읽어 원장이랑 비교
  - 다를 경우 
    1. 프로그램 자동화
    2. 작업 대기열에 넣고 재무팀에서 수동으로 수정
    3. 재무팀에서 직접 조사

결제 실패 처리

- 결제 상태 추적 데이터 별도 보관 
  - 결제 거래의 현재 상태를 파악하고 재시도 혹은 환불이 필요한지 여부를 결정
- 재시도 큐 및 실패 메세지 큐
  - 재시도 : 일시적 오류로 인해 발생한 문제여서, 재시도 했을 때 충분히 복구 가능한 경우
  - 실패 : 반복적으로 처리에 실패한 메시지 

정확히 한번만 결제

-> 간단하게 생각해서 발행된 메세지에 대해 최소 한번은 실행 / 최대 한 번 실행로직을 적용

재시도 메커니즘 

- 즉시 재시도 : 실패시 즉시 요청을 다시 보냄
- 고정 간격 : 실패 시 일정 시간 기다리는 방식
- 증분 간격 : 기다리는 시간을 점진적으로 늘려 나가는 방식
- 지수적 백오프 : 기다리는 시간을 두배씩 늘려가는 방식
- 취소 : 실패시 요청 철회

멱등성

고객이 결제 버튼을 여러번 누르는 경우 

- 결제 요청을 받을 경우 데이터베이스에 새로운 record를 넣으려고 시도
- 결제 내역 X : 새 레코드 추가에 성공 
- 결제 내역 O : 중복 요청 처리 X 

PSP가 결제를 성공적으로 처리했지만 네트워크 오류로 결제 시스템에 전달되지 않아 다시 클릭 하는 경우 

- 결제 서비스는 PSP에 비중복 난수를 전송 -> PSP는 이에 해당하는 토큰을 발행
- 토큰 -  난수 = 1 : 1
- 재시도하는 경우 같은 토큰으로 보내기 때문에 중복 결제 X

## 💡 3. 전부 읽고 난 후기

- 

## ❓ 4. 특별히 궁금했던 부분

- 