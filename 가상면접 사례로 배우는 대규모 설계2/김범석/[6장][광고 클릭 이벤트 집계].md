# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각

- 몰로코와 같은 기업에서 사용하는 방식과 비슷한 방식일까?

## 📝 2. 내용 정리

데이터

원시 데이터 vs 집계 결과 데이터 

|      | 원시 데이터만 보관                                           | 집계 결과 데이터만 보관              |
| ---- | ------------------------------------------------------------ | ------------------------------------ |
| 장점 | 원본 데이터를 손실 없이 보관<br />데이터 필터링 및 재계산 지원 | 데이터 용량 절감<br />빠른 질의 성능 |
| 단점 | 막대한 데이터 용량 <br />낮은 질의 성능                      | 데이터 손실                          |

둘다 저장하는 것이 유리

- 문제가 발생하면 디버깅에 활용할 수 있도록 원시 데이터 보관 
- 다만 원시 데이터는 양이 엄청나므로 직접 query하기에는 비효율적. => 집계 결과 데이터를 질의 

집계 서비스

- 광고 클릭 이벤트를 집계하는 좋은 방안 중 하나 : 맵리듀스 프레임워크 (DAG)
- 맵 노드
  - 데이터 출처에서 읽은 데이터를 필터링 하고 변환하는 역할을 담당
- 집계 노드
  - ad_id별 광고 클릭 이벤트 수를 매 분 메모리에서 집계
- 리듀스 노드 
  - 모든 집계 노드가 산출한 결과를 최종 결과로 축약

### 상세 설계

스트리밍 vs 일괄 처리 

|        | 서비스                 | 일괄 처리                    | 스트리밍                     |
| ------ | ---------------------- | ---------------------------- | ---------------------------- |
| 응답성 | 빠른 응답              | 응답 X                       | 응답 X                       |
| 입력   | 사용자의 요청          | 큰 규모의 데이터             | 입력에 경계 X                |
| 출력   | 클라이언트에 대한 응답 | 구체화 뷰, 집계 결과 지표 .. | 구체화 뷰, 집계 결과 지표 .. |
| 사례   | 온라인 쇼핑            | 맵 리듀스                    | 플링크                       |

데이터 재계산

- 때로 이미 집계한 데이터를 다시 계산해야하는 경우 (버그 장애 및 등등 ..)
  1. 재계산 서비스는 원시 데이터 저장소에서 데이터를 검색한다 (일괄 처리 프로세스를 따름)
  2. 추출된 데이터는 전용 집계 서비스로 전송됨 (실시간 데이터 처리과정과 과거 데이터 재처리 프로세스와의 분리)
  3. 집계 결과는 두번째 메시지 큐로 전송되어 집계 결과 데이터베이스에 반영

시간

- 집계를 위해서는 타임스탬프가 필요함
  - 이벤트 시간 : 광고 클릭이 발생한 시간
  - 처리 시간 : 집계 서버가 클릭 이벤트를 처리한 시스템 시간

|             | 장점                                     | 단점                                                         |
| ----------- | ---------------------------------------- | ------------------------------------------------------------ |
| 이벤트 시간 | 집계 결과가 보다 정확                    | 클라이언트가 생성한 타임스탬프에 의존하는 방식<br />클라이언트의 고의적 조작에 대해 자유로울 수 없음 |
| 처리 시간   | 서버 타임스탬프가 클라이언트 보다 안정적 | 이벤트가 시스템에 도착한 시각이 한참 뒤인 경우에는 집계 결과가 부정확 |



집계 윈도

- 텀블링 윈도
  - 시간을 같은 크기의 겹치치 않는 구간으로 분할
- 슬라이딩 윈도
  - 데이터 스트림을 미끄러져 나아가면서 같은 시간 구간 안에 있는 이벤트를 집계

전달 보장 

- **정확히 한번**을 지원 해야 함. (광고비와 연관있기 때문에)
  - 데이터 중복 제거 
    - 데이터 저장 후 응답 과정에서 에러가 발생하면 재시도 시작
    - HDFS나 S3같은 외부 파일 저장소에 오프셋을 기록하는 방식
    - 오프셋 확인의 경우 카프카에서 받아온 후 실시
    - 오프셋 커밋의 경우 집계 결과 성공 응답을 받운 후 실시
    - 다만 분산 트랜잭션을 구축하여 일관성을 보장해야 함

핫스팟 문제

- 다른 서비스나 샤드보다 더 많은 데이터를 수신하는 서비스나 샤드를 일컬음
- 이런 서비스의 경우 서비스 노드를 더 할당하여 완화하는 방식을 채택

결함 내성

- 집계는 메모리에서 이루어지므로 집계 노드에 장애가 생기면 결과도 손실됨
- 데이터를 원점부터 다시 재생하여 집계하면 시간이 오래 걸림
- 업스트림 오프셋 같은 시스템 상태를 스냅숏으로 저장하고 마지막으로 저장된 상태부터 복구하는 방식으로 진행 



## 💡 3. 전부 읽고 난 후기

- 전반적으로 큰 그림이 잘 그려지지 않음. 어렵다

## ❓ 4. 특별히 궁금했던 부분

- (결함 내성) 복구 시 스냅숏 저장이 과연 실질적인 효율이 있는 것일까..? 
- 광고 집계시 이벤트 발생 시각이 조작된 경우에는 어떻게 하는 게 옳은 것일지?
  - 만약 조작된 것이 고의가 아닌 기계적 결함이라면?