# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각
- 근접성 서비스가 뭐지? 네이버 지도 같은건가? 가까운 곳 찾기?

## 📝 2. 내용 정리

### QPS 계산식
$$
QPS = (DAU \cdot Action) \cdot 10^5, 
(86400 \approx 10^5)
$$

### 근접성 서비스 알고리즘
- 2차원 검색
- 균등 분할 격자
- **지오해시**
- **쿼드트리**
- **구글 S2**

## 2차원 검색
- 이름 그대로, 2차원 형태의 위도 경도 데이터를 바탕으로 조회하는 방식이다.
```SQL
SELECT *
FROM earth
WHERE (latitude BETWEEN my_latitude - radius AND my_latitude + radius) AND (longitude BETWEEN my_longitude - radius AND my_longitude + radius)
```
- 모든 테이블을 탐색해야하므로 성능이 좋지 않다.

## 균등 분할 격자
- 이름 그대로, 격자를 분할하는 방식이다.
- 격자를 분할해놓고, 실제 위치에 있을 때는 해당 격자만을 바탕으로 조회하면 데이터의 양이 현저히 떨어질 것이다. (파티셔닝)
- 하지만, 사업장은 위치마다 밀집 구역이 있고 적은 구역이 있기에 효율적이지는 않다. 만약 밀집구역에 많은 요청이 들어온다면 동일하게 조회 성능은 떨어 질 것이다.

## 지오해시
- 재귀의 형태로 고유 키 이진 값을 만들어나간다.
- 이때, 정밀도를 위해서 적절한 격자 크기를 사용해야 한다.
- 격자 가장자리 Prefix 이슈가 있다. 이를 위해, 인접 격자 탐색 방법을 사용한다. (BFS)

## 쿼드트리
- 질의에 응답 할 수 있는 데이터를 트리구조로 메모리에 담아두는 방식이다. (DFS)
- 쿼드트리를 전부 저장하는데 필요한 메모리를 상당히 많이 사용하게 되고, 부팅 시에 메모리를 적재하는 기간동안 대기가 필요하다. (스프링은 기존에도 무거운데, 이것도 기다리면 상당하긴 할 것 같다.)
- 트리 구축 시간 복잡도  

$$
\frac{N}{M}\log\left(\frac{N}{M}\right), (M = 말단노드 사업장 수, N = 전체 사업장 수)
$$

## 💡 3. 전부 읽고 난 후기
- 1권 읽었을 때도 그렇지만 이런 디테일 한 설계 없이 개발하는 경우가 비일비재하다.
- 실제로 엔지니어들은 이렇게 개발을 하는 것 같은데, 나는 이걸 아직 고려를 하지 못하는 것 같다. 실제 개발 시에 QPS를 계산하는 것을 연습해보자.

## ❓ 4. 특별히 궁금했던 부분
- 내부 노드의 수가 왜 말단 노드의 (1/3) 인가.
- 쿼드트리 갱신 시 서버 네트워크 분리를 어떻게 해야하는가.
