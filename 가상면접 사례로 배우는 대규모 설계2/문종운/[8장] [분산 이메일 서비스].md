# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각
- 분산 이메일 서비스라는 목차가 있는 것처럼 이메일 서비스를 진행하는 과정에서 여러 서버에 동시 다발적으로 들어오는 이메일을 어떻게 한 번만 보낼 것인지에 대한 내용을 담고 있지 않을까 하는 생각이 든다.
- 추가적으로, Email 관련 Protocol을 처리하는 과정에서는 프로토콜과 입출력 I/O로 인해서 생각보다 많은 비용이 발생한다. 이 과정에서 스레드의 수를 어떻게 조절 할 것이며, 이메일을 실패하는 경우에 어떤 방식으로 처리 할 것 인지에 대한 얘기가 나오지 않을까 싶다.
- EX) A 이메일 전송 실패 -> B 이메일 전송 실패 or 성공 -> 문자 메시지 전송 실패 or 성공 -> Alert(?)
- 부가적으로 이메일에 대한 protocol은 여러가지가 있는 것으로 알고 있는데, 유저가 선택한 protocol에 따라 다른 형태의 이메일이 보내져야 한다. 이러한 형태에서 가장 적합한 형태가 output이 바뀌는 헥사고날을 선택해도 좋을 것 같다.

## 📝 2. 내용 정리

### 기능 요구사항
- 인증
- 이메일 발송/수신
- 모든 이메일 가져오기
- 읽음 여부에 따른 이메일 필터링
- 제목, 발신인, 메일 내용에 따른 검색
- 스팸 및 바이러스 방지 기능

### 비기능 요구사항
- **안정성** : 이메일 데이터는 소실되어서는 안된다. 또한, 전송 시에 유실되어서도 안된다.
- **가용성** : SPOF를 방지해야 한다.
- **확장성** : 사용자 수가 늘어나도 시스템이 감당가능해야 한다.
- **유연성** : 별도의 맞춤형 프로토콜을 이용하여 컴포넌트 확장에 용이해야 한다.

### 이메일 프로토콜

#### SMTP
- 이메일을 **한 서버에서 다른 서버로 보내는** 표준 프로토콜

#### POP
- 이메일 **클라이언트가 원격 메일 서버에서 이메일을 수신하고 다운로드**하기 위해 사용하는 표준 프로토콜
- 만약 클라이언트에서 원격 메일 **서버의 이메일을 다운로드 하면 서버의 이메일은 삭제** 된다.
- 이메일 다운로드 시 이메일의 **Content(첨부파일 포함)를 모두 내려받아**야 해서 읽으려면 시간이 오래 걸린다.

#### IMAP
- POP와 같이 이메일 **클라이언트가 원격 메일 서버에서 이메일을 수신하고 다운로드**하기 위해 사용하는 표준 프로토콜이다. 개인 이메일 계정에서 가장 널리 사용되는 프로토콜이다.
- 다른 점은 **클라이언트에서 다운로드를 시도해야 다운로드**가 되며 **이메일 서버에서 데이터가 삭제되지 않는다.** 따라서, 여러 클라이언트에서 해당 메일을 읽어들일 수 있다.
- 또한, 모든 Content를 다운받는 것이 아닌 **이메일을 열기 전에 헤더만 다운로드**하기 떄문에 빨리 확인 할 수 있다.

#### HTTPS
- HTTP 프로토콜로 하여금 웹 기반 이메일 시스템을 구축 할 수 있다.

### 전통적 메일 서버

#### 과정
1. A 클라이언트가 이메일 클라이언트에 접속하여 SMTP 프로토콜을 통해 DNS를 탐색하여 B 클라이언트의 이메일 서버에 이메일을 보낸다.
2. B 클라이언트가 이메일 클라이언트에 접속하여 POP, IMAP 프로토콜을 통해 이메일을 가져온다.
3. 이 과정은 반대 방향으로도 동일하다.

#### 저장소
전통적인 아키텍처에서는 파일 시스템의 디렉터리에 저장하며, 고유한 이름을 가진 별도 파일로 보관을 하였다.  
이 때, 고객 간의 분리를 위하여 고객 별로 디렉터리를 만들어 이메일을 보관하는 형태였다.  
[단점] : 이메일의 개수와 유저가 늘어남에 따라 디스크 I/O가 병목이 된다.

### 분산 메일 서버

#### 분산 메일 서버 컴포넌트
1. 웹메일 : 사용자는 웹브라우저를 사용해 메일을 받고 보낸다.
2. 웹서버 : 사용자가 이용하는 요청/응답 서비스로, 로그인, 가입, 사용자 프로파일 등에 대한 관리 기능 담당. (이메일 API 요청 처리)
3. 실시간 서버 : 새로운 이메일 내역을 클라이언트에 실시간으로 전달하는 역할, Web Socket, Long Polling 방식 사용.
4. 메타데이터 데이터베이스 : 이메일의 메타데이터(제목, 본문, 발신인, 수신인 목록 등)를 저장하는 데이터베이스
5. 첨부파일 저장소 : 이메일로 전송되는 첨부파일을 저장하기 위한 용도 (객체 저장소 인 AWS S3)
6. 분산 캐시 : 최근에 수신된 이메일을 클라이언트에 캐시하여 메일을 표시하는 시간을 줄이는 용도
7. 검색 저장소 : 분산 문서 저장소로 텍스트 검색을 더욱 빠르게 처리하기 위해서 사용하는 용도

#### 과정
1. A 클라이언트가 메일 전송을 시도하여 로드밸런서로 요청이 보내어진다.
2. 로드밸런서를 거쳐서 웹 서버에서는 도메인 검증, 스팸, 바이러스 검사를 진행한다. 만약, 도메인이 동일하다면 SMTP 통신의 과정이 필요없이 HTTP 프로토콜로 종료된다. (4단계 이후 수행 X)
3. 검증이 실패한 메일은 에러 큐로, 검증이 성공한 메일은 외부 전송 큐로 전달하며 첨부파일은 S3에 보관한다. 즉, 메시지 큐와 Store 계층에 저장한다.
4. SMTP 통신을 통해 메일을 송신하며 스팸, 바이러스 검사를 재차 진행한다. 만약 실패하는 경우에는 재시도를 한다.
5. B 클라이언트는 SMTP 서버로 부터 이메일을 수신받고 수신 이메일 큐로 보내어 여러 이벤트를 처리한다.
6. 처리가 완료되면 B 클라이언트의 웹 메일 애플리케이션에 수신 된 이메일을 보여준다.

### 데이터 베이스 선정
- 이메일은 어떤 Content 이냐에 따라서 상당히 많은 데이터가 보관 될 수 있으므로 관계형 데이터베이스는 적합하지 않다.
- BLOB 컬럼을 사용한다고 하더라도 BLOB 컬럼에 대한 검색 질의의 성능이 좋지 않다.
- S3와 같은 저장소를 사용 할 수 있으나 단순히 데이터를 보관하는 용도이기에 이메일을 위한 여러 기능을 위한 확장성이 좋지 않다.
- NoSQL을 사용 할 수 있지만, NoSQL은 MySQL에 비해서 검색 질의의 성능이 상당히 떨어지기 떄문에 좋지 않다.
[결론] : 대체로는 이메일 서비스를 위한 별도의 독자적인 데이터베이스 시스템을 만들어 사용한다.

### 이메일 데이터베이스 설계 조건
- 단일 칼럼의 크기는 **한 자릿수 MB** 일 수 있다.
- 강력한 데이터 일관성이 보장되어야 한다.
- 디스크 I/O가 최소화되도록 설계되어야 한다.
- 가용성이 아주 높아야 하고 일부 장애를 감내할 수 있어야 한다.
- 증분 백업(incremental backup)이 쉬워야 한다.

### 일관성 문제
분산 이메일 서비스이기에 분산 서버에서 가장 많이 고려해야 할 부분은 데이터 정합성과 가용성 사이의 트레이드오프를 판단해야 한다. 이메일 서비스는 데이터 정합성이 무엇보다 중요하기 때문에 다른 사본 서버에 데이터가 복제되기 이전까지 다른 작업을 처리하면 안된다.

### 이메일 전송 가능성
새로 구성한 메일 서버가 메일을 전송 할 때, 각 메일 서버의 플랫폼들은 신규 메일 서버로부터 도착한 메일들은 스팸으로 분류한다.  
따라서, 이메일의 전송 가능성을 높이기 위한 방법이 필요하다.

#### 전용 IP
- 이메일을 보낼 때에는 유동적인 IP가 아닌 고정 IP를 사용하여 이메일의 평판을 높인다.

#### 범주화
- 아예 범주가 다른 이메일은 다른 IP로 보내야 한다. 즉, 공지성 메일과 광고성 메일의 IP는 분리해서 보내라.

#### 피드백 처리
- ISP로부터 오는 피드백을 빠르게 수용하여 처리 할 수 있도록 해야 한다.

### 검색
이메일 시스템에서의 검색 기능에서는 쓰기 연산보다 읽기 연산이 더 많이 발생한다. 검색 기능을 제공하기 위해서는 송신(보낸 메일함), 수신(받은 메일함), 삭제(휴지통, 받은 메일함)의 색인 작업을 별도로 수행해야 한다.  

#### 엘라스틱 서치
- 검색은 HTTP 요청을 통해 엘라스틱 서치와 통신하여 검색 결과를 가지고 온다.
- 각각의 위 작업들(송신, 수신, 삭제)에 대해서는 별도의 이벤트 처리를 통해서 색인 작업을 진행하도록 한다.

#### 맞춤형 검색 솔루션 제작
- 검색 솔루션에서 가장 복잡한 문제는 디스크 I/O 병목을 어떻게 해결 할 것인가에 대한 작업이 중요하다.
- 이 때, 가장 많이 사용되는 방식이 LSM(Log-Structured Merge) 트리를 사용하며, 계층 별도 가장 접근하기 용이한 디스크 or 메모리에 먼저 적재하는 방식이다. 이후로 임계점을 넘어가게 되면 공간 접근성이 떨어지는 상위 계층에 전달하여 보관한다.
- 맞춤형 검색 솔루션을 만드는데에는 많은 엔지니어링 자원이 필요하므로 작은 이메일 시스템에서는 엘라스틱서치를 사용하는 것이 용이하다.

## 💡 3. 전부 읽고 난 후기
- 실제 Gmail과 같은 이메일 서비스를 만드는 챕터여서 당황스러웠다. 이미 상용화되어있는 서비스를 이용하다보니 이메일 서비스를 어떻게 다루어야 할 것인가에 대해서는 생각을 해본적이 없어서 어려웠다.
- 특히, 대량의 파일 데이터를 저장하기 위한 방식이 아직 와닿지가 않는다. 파일 시스템에 대한 이해도가 부족한 게 아닐까 하는 생각이 들었다. 프로그램으로써 파일이 저장되는 방식에 대한 지식 보충이 필요하다는 것을 느꼈다.

## ❓ 4. 특별히 궁금했던 부분
- 웹 계층이든 별도의 프로토콜이든 저희는 파일을 전송 할 수 있습니다. 여기서는 BASE64 인코딩 방식으로 파일을 전송을 하는 것으로 되어있는데 어떤 하나의 파일이 어떻게 비트 단위로 쪼개어져서 전송이 되고 수신을 했을 떄 해당 파일을 사용 할 수 있는걸까요.
  - 한글 파일이라면 한글 파일의 적절한 확장자가 관리가 되고, 메모장이라면 메모장에 대한 확장자 파일도 관리가 되고... 또 음악 파일이라면 음악 파일 고유의 인코딩 방식이 유지가 되는데 도대체 어떻게 되는걸까요
