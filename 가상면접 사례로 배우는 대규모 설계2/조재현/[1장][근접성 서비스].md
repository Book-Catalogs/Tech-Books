# 📚 스터디 템플릿

## 📖 1. 목차를 읽기 전에 든 생각
- 지도 서비스? 거리 관련한 이야기는 들어봤는데, 공간 인덱스 이런 이야기를 하려나?
- 최근에도 4분면으로 나눠서 지도에 대한 성능을 높이는 이야기가 있었는데 한번 알아보자~!

## 📝 2. 내용 정리

### 주제
지도 상에서 현재 위치에서 거리마다 존재하는 가게 관련 정보를 탐색한다.

### 1. 비즈니스 분석 

#### 읽기 (조회)
- 가장 많이 일반 사용자가 사용하는 기능
- 위경도 기준으로 사업장 목록을 반환한다.
- 사업장의 상세 정보를 조회할 수 있다.

#### 쓰기 (사업장 정보 등록 변경 삭제)
- 사업자와 같이 지도 정보에 변경의 필요성이 필요한 사용자
- 해당 기능은 생각보다 읽기보다 빈번하게 이루어지지 않음

#### 성능
- 낮은 지연 응답을 추구한다.
- 개인 정보와 같은 내용은 보호되어야 함
- 인구 밀집 지역, 사용자가 몰리는 트래픽을 감당해야 한다.

### 2. 아키텍처 설계
1. LSB 서비스 
- 사업장 정보, 지오해시를 레디스 클러스터로 읽기

2. 사업장 서비스 (주 데이터 베이스 쓰기)
- 주 데이터 베이스에 쓰기
- 주 데이터베이스는 repl진행
- repl된 데이터는 레디스 클러스터로 주기적으로 동기화

### 3. 탐색 방법
#### 2차원 검색
단순히 위경도로 데이터를 조회한다.<br>
특정 데이터 조회는 가능하겠지만, 주어진 반경을 조회하려면 훨씬 많은 연산이 들어가야 함

#### 균등 격자
단순히 격자 방식으로 나누어 조회한다. <br>
상대적으로 트래픽이 많이 몰리는 사업장에는 성능이 떨어질 수 있음

#### 지오해시
위경도 데이터를 문자열로 변환한다. 4분면으로 계속 분할한다 <br>
지오해시 길이에 따라 3cm - 지구 전체까지 탐색 가능<br>
자신과 사업장 거리가 가깝지만, 격자 가장자리의 경우 공통 접두어가 없거나, 서로 다른 격자에 놓일 수 있음

#### 쿼드 트리
재귀적으로 사분면 분할을 시도 한다. <br>
서버를 릴리즈 할때 너무 많은 서버에 배포되면 지연시간이 발생할 수 있다.-> 블루그린 방식으로 전환도 좋지만, 동시에 많은 읽기로 부하가 발생하는 것도 생각해야 함 <br>
쿼드 트리가 추가되거나 삭제되면서 갱신이 필요한 경우도 신경써야 한다. -> 실시간성 여부에 따라 다른 전략을 생각해야한다. (락 문제 우려)

#### 구글 S2
쿼드트리와 같은 메모리 기반 해결 방법, 힐베르트 곡선과 공간 채움 곡선을 활용 <br>
인접한 두 지점은 인덱싱 이후 1차원 공간 내에서도 인접한 위치에 있음 -> 사각형의 구획이 아닌, 다각형 형태로 영역 지정 알고리즘을 사용한다.<br>

### 4. 상세 설계
#### 사업장 테이블 샤딩
데이터가 많이 쌓이게 되면 수평적으로 테이블을 분할한다.<br>
수직적으로 분할하는 건 파티셔닝!

#### 복합키
지오해시와 사업장 ID를 합친 복합키를 사용하면 사업장 정보를 추가하고 삭제하기가 쉽다.(락 사용이 필요 없음) <br>

#### 캐시 키
사용자가 조금이라도 움직인다면 정확도가 떨어지기 때문에 변화가 없도록 조정하는게 중요 <br>
특정 지오해시에 사업잦ㅇ id를 계산하고 레디스에 캐싱해둔다. 사업장에 쓰기가 일어나면 캐시에 보관된 항목은 무효화하면 된다.(상대저긍로 빈도가낮아 락 사용 안해도 됨)

## 💡 3. 전부 읽고 난 후기
- MySQL의 공간 인덱스 개념도 같이 공부해보면 좋을 듯 하다.
- 아키텍처에서 항상 등장하는 캐싱, 그리고 replication. 어떤 목적으로 어떻게 쓰냐에 따라서 최대한 효율적인 설계 방법을 떠올려볼 수 있구나
- 어찌보면 알고리즘에 가깝기도 하지만 위도와 경도라는 개념 하나도 이렇게 다양하게 해석하고 접근하면서 문제를 최적화할 수 있다는 거에 많이 배웠음

## ❓ 4. 특별히 궁금했던 부분
1. RDB 중 읽기 성능이 가장 좋은거??
2. Replication중에 문제가 생겨서 일부 데이터만 Repl됐다면 이후 처리는 어떻게 해볼 수 있을까?
3. 샤딩이나 파티셔닝의 기준? 
4. Global 이라면 어떤 것들을 조금 더 생각해볼 수 있을까? (ex 범석이형이 한국에서 유럽 신혼여행 계획을 짠다면?)
